# SDKs, The Laravel way

M·ªói cu·ªôc g·ªçi t∆°i Builder s·∫Ω ƒëi·ªÅu ch·ªânh c√°c request ƒëang ch·ªù x·ª≠ l√Ω c∆° b·∫£n. M·ªói s·ª± ƒëi·ªÅu ch·ªânh, m·ªôt li√™n k·∫øt kh√°c trong
chu·ªói, c√°i m√† s·∫Ω ƒë∆∞·ª£c g·ª≠i cu·ªëi c√πng v·ªõi get().

![the laravel way](../images/request-anatomy@2x-2.png)

ƒêi·ªÅu th·ª© v·ªã t√¥i nh·∫≠n ƒë∆∞·ª£c khi s·ª≠ d·ª•ng c√°c API ƒë∆∞·ª£c x√¢y d·ª±ng ƒë·∫πp ƒë·∫Ω l√† t√¥i kh√¥ng th·ªÉ hi·ªÉu. M·ªôt l√† c√°ch ti·∫øp c·∫≠n cho ng∆∞·ªùi
m·ªõi bƒÉt ƒë·∫ßu, m·ªôt l√† m·ªôt c√∫ ƒë·∫•m cho c√°c k·ªπ s∆∞ cao c·∫•p. ƒê·∫πp, ƒë∆°n gi·∫£n v√† linh ho·∫°t. M·ªôt k·∫øt n·ªëi kh√≥ n·∫Øm b·∫Øt c√°i m√† t·∫•t c·∫£
c√°c k·ªπ s∆∞ t√≤ m√≤ nh∆∞ng c√≥ nh·ªØng ng∆∞·ªùi s·∫Ω kh√¥ng t√¨m hi·ªÉu n√≥.
The joy I get when using a beautifully-crafted API cannot be understated. One that is approachable for beginners, and
can pack a punch for advanced engineers. Beautiful, simple, flexible. An elusive combination that all engineers strive
for, but some never find.

üí°
> tldr;G√¢n ƒë√¢y t√¥i ƒë√£ x√¢y d·ª±ng 1 SDK cho API c·ªßa ConnectWise, l·∫•y c·∫£m h·ª©ng t·ª´ 1 v√≠ d·ª• c·ªßa Eloquent. N√≥ l√†

# ƒê√≥ l√† 1 s·ª± ƒë·∫ßu t∆∞

Lau s·∫°ch l·ªõp b·ª•i cho 1 ƒë·∫∑c t√≠nh c≈© h√†ng tu·∫ßn, h√†ng th√°ng, th·∫≠m ch√≠ l√† nh·ªØng nƒÉm sau, t√¥i mu·ªën gi·∫£m s·ªë l·∫ßn c√†o ƒë·∫ßu cho
ƒë·∫øn khi t√¥i hi·ªÉu ƒë∆∞·ª£c t√¥i ƒëang th·∫•y c√°i g√¨. S·ª≠ d·ª•ng Laravel trong nhi·ªÅu nƒÉm, t√¥i nh·∫≠n ra c√°c APIs l·ªói c·ªßa n√≥ d·ªÖ d√†ng ƒë·ªÉ
quay l·∫°i. V√¨ v·∫≠y, thi·∫øt k·∫ø nh·ªØng th·ª© trong c√°ch gi·ªëng nh∆∞ `b·∫£n ƒë·ªãa` v·ªõi Laravel l√† 1 s·ª± ƒë·∫ßu t∆∞ cho t∆∞∆°ng lai c·ªßa ch√≠nh
t√¥i.

# M·ªôt v√≠ d·ª• Eloquent

B·∫°n th∆∞·ªùng t√¨m n·∫°p d·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u trong Laravel nh∆∞ n√†o? Eloquent. H·∫ßu h·∫øt th·ªùi gian ( kh√¥ng ph·∫£i t√¢t c·∫£), M·ªôt SDK(
C√¥ng c·ª• ph√°t tri·ªÉn ph·∫ßn m·ªÅm ) ch·ªâ l√† 1 l·ªõp tr·ª´u t∆∞·ª£ng cho t√¨m n·∫°p d·ªØ li·ªáu t·ª´ 1 API. Th·ªânh tho·∫£ng, no ch·ªâ l√† 1 tr√¨nh bao
b·ªçc ƒë∆°n gi·∫£n xung quanh vi·ªác t·∫°o c√°c HTTP requests. Nh∆∞ng s·ª± kh√°c bi·ªát gi·ªØa t√¨m n·∫°p d·ªØ li·ªáu t·ª´ Database v√† t√¨m n·∫°p d·ªØ
li·ªáu t·ª´ API l√† g√¨?

![the laravel way](../images/eloquent-anatomy@2x.png)

N·∫øu ch√∫ng ta s·ª≠ d·ª•ng c√°c Model Eloquent ƒë·ªÉ nh·∫≠n d·ªØ li·ªáu t·ª´ CSDL c·ªßa ·ª©ng d·ª•ng. T√¨m n·∫°p d·ªØ li·ªáu s·∫Ω tr√¥ng nh∆∞ n√†y:

```php
// filtering
Ticket::where('status', 'open')->get();
Ticket::open()->get();

// selecting fields
Ticket::select(['id', 'summary'])->get();
Ticket::get(['id', 'summary']);

// sorting
Ticket::orderBy('created_at', 'desc')->get();
Ticket::latest()->get();

// eager loading
Ticket::with(['board', 'notes'])->get();

// all
Ticket::get();
```

Ch√∫ng ta c√≥ 1 Model, nh·ªØng ph∆∞∆°ng th·ª©c c√°i m√† tr·∫£ v·ªÅ 1 ƒë·ªëi t∆∞·ª£ng `Builder` cho c√°c ph∆∞∆°ng th·ª©c chu·ªói t∆∞∆°ng lai, v√† nh·ªØng
ph∆∞∆°ng th·ª©c c√°i m√† th·ª±c thi c√°c truy v·∫•n v√† tr·∫£ v·ªÅ `Collection`.

T·∫°i sao ch√∫ng ta kh√¥ng, thay v√¨ x√¢y d∆∞·ª£ng 1 `query` ƒë·ªÉ th·ª±c thi, ch√∫ng ta x√¢y d·ª±ng 1 `HTTP request` ƒë·ªÉ g·ª≠i?

V·ªõi nh·ªØng s·ª± so s√°nh n√†y trong ƒë·∫ßu, module h√≥a SDK c·ªßa ch√∫ng t√¥i ƒë·ªÉ b·∫Øt ch∆∞·ªõc Eloquent ...c·∫£m gi√°c ƒë√∫ng. N√≥ gi·ªëng nh∆∞
b∆°i tr√™n d√≤ng n∆∞·ªõc. R·∫•t t·ª± nhi√™n. Gi·ªëng nh∆∞ h∆°i th·ªü.

# L·∫•y T·ªãckets

Cu·ªôc g·ªçi c∆° b·∫£n nh·∫•t, kh√¥ng y√™u c·∫ßu l·ªçc, kh√¥ng y√™u c·∫ßu s·∫Øp x·∫øp, s·∫Ω tr√¥ng nh∆∞ th·∫ø n√†y.

```php 
$tickets = Ticket::get();
```

N·∫øu kh√¥ng c√≥ l·ªói x·∫©y ra ch√∫ng ta s·∫Ω nh·∫≠n ƒë∆∞·ª£c `Collection`

# Model Ticket

```php

class Ticket {

public function  get():Collection 

{
 $settings = config('services.connectwise');

        $response = Http::baseUrl($settings['url'])
            ->withBasicAuth(
                "{$settings['company_id']}+{$settings['public_key']}",
                $settings['private_key'],
            )
            ->asJson()
            ->acceptJson()
            ->withHeaders(['clientId' => $settings['client_id']])
            ->throw()
            ->get($this->url());
        
        return new Collection($response->json());
}
public function url ():string 
{
 return '/tickets';
}

}

```

Ph∆∞∆°ng th·ª©c `get()` tr√¥ng kh√° d·ªã, nh∆∞ng n√≥ ch·ªâ laasyc c√°c thi·∫øt l·∫≠p k·∫øt n·ªëi, x√¢y d·ª±ng request, ƒë√≥ng g√≥i response trong
1 `collection`. Ch√∫ng ta s·∫Ω ƒë∆°n gi·∫£n h√≥a n√≥ sau.

> üí° ƒê·ª´ng c·∫£m th·∫•y sowh h√£i ƒë·ªÉ t·∫°o ra c√°c request c∆° b·∫£n c·ªßa ch√≠nh b·∫°n! N·∫øu API c·ªßa b·∫°n kh√¥ng s·ª≠ d·ª•ng JSON, hay kh√¥ng s·ª≠
> d·ª•ng c√°c ƒë·ªãnh d·∫°ng kh√°c c·ªßa x√°c th·ª±c, h√£y thay ƒë·ªïi nh·ªØng th·ª© c·∫ßn thi·∫øt trong HTTP Client

Connection Settings
To make our base request work we'll need to add some values to our services config.

return [

    // other services ...
    
    'connectwise' => [
        'url' => env('CONNECTWISE_URL'),
        'public_key' => env('CONNECTWISE_PUBLIC_KEY'),
        'private_key' => env('CONNECTWISE_PRIVATE_KEY'),
        'client_id' => env('CONNECTWISE_CLIENT_ID'),
    ],

];

# Thi·∫øt l·∫≠p k·∫øt n·ªëi

ƒê·ªÉ l√†m cho nh·ªØng request c·ªßa ch√∫ng ta ho·∫°t ƒë·ªông, ch√∫ng ta c·∫ßn ƒë·ªÉ th√™m nh·ªØng gi√° tr·ªã t·ªõi c·∫•u h√¨nh `services` c·ªßa ch√∫ng
ta .
> üí° t√¥i ƒë√£ ch·ªçn c·∫•u h√¨nh ƒë·ªÉ l∆∞u c√°c thi·∫øt l·∫≠p connection API c·ªßa t√¥i. Nh·ªØng thi·∫øt l·∫≠p c√≥ th·ªÉ ƒë·∫øn t·ª´ b·∫•t k√¨ ƒë√¢u; m·ªôt
> model kh√°c trong h·ªá th·ªëng ƒëa ng∆∞·ªùi thu√™, t·ª´ 1 package gi·ªëng nh∆∞ `spatie/laravel `, t√πy thu·ªôc v√†o b·∫°n.

```php

return [

    // other services ...
    
    'connectwise' => [
        'url' => env('CONNECTWISE_URL'),
        'public_key' => env('CONNECTWISE_PUBLIC_KEY'),
        'private_key' => env('CONNECTWISE_PRIVATE_KEY'),
        'client_id' => env('CONNECTWISE_CLIENT_ID'),
    ],
    
];
```

# Cho ph√©p th·ª±c hi·ªán g·ªçi c√°c cu·ªôc g·ªçi ph∆∞∆°ng th·ª©c tƒ©nh

Ch√∫ √Ω r·∫±ng ph∆∞∆°ng th·ª©c `get` kh√¥ng `static`? t·∫•t nhi√™n b·∫°n ƒë√£ l√†m

```php

class Ticket 
{
//get() 
//url() 

public static  function  __callStatic($method, $parameters)
{
return (new static())->$method(...$parameters);

}
}

```

ƒê√≥ l√† b·∫£n sao tr·ª±c ti·∫øp t·ª´ Model Eloquent laravel. ƒê√≥ l√† t·∫•t c·∫£ nh·ªØng g√¨ b·∫°n c·∫ßn l√†m.
T·ª´ `Ticket` b·∫°n c√≥ th·ªÉ `call` t·∫•t c·∫£ c√°c ph∆∞∆°ng th·ª©c tr√™n `Ticket` model.

```php

Ticket::get();
Ticket::url();

// instead of

(new Ticket)->get();
(new Ticket)->url();
```

# L·ªçc, s·∫Øp x·∫øp, gi·ªõi h·∫°n

![The laravel way](../images/request-anatomy@2x-1.png)

Trong Eloquents, nh·ªØng m·ªëi quan t√¢m ƒë∆∞·ª£c x·ª≠ l√Ω b·ªüi ƒë·ªëi t∆∞·ª£ng `Builder`. ƒê·ªëi t∆∞·ª£ng n√†y ch·ªãu tr√°ch nhi·ªám cung c·∫•p 1 giao
di·ªán m∆∞·ª£t m√† cho
vi·ªác `c·∫≠p nh·∫≠t` c√°c `thu·ªôc t√≠nh` c·ªßa ch√≠nh n√≥ v√† tr·∫£ v·ªÅ th·ª±c th·ªÉ cho ph√©p c√°c `method chaining`

```php

class RequestBuider 
{


public ?PendingRequest  $request = null;
public ?Model $model = null;

public function __construct($request, $model)
{
$this->model = $model;
$this->request= $request;
}
 // where()
    // whereIn()
    // whereBetween()
    // whereNull()
    // limit()
    // select()
    // ... and so on
    
    public  function  get( ):Collection 
    {
    $response =  $this->request->get($this->model->url());
    return new Collection ($response->josn());
    }
    
}
```

Nh∆∞ b·∫°n th·∫•y, ƒë·ªëi t∆∞∆°ng n√†y nh∆∞ ch·∫•t `k·∫øt d√≠nh` gi·ªØa HTTP request `PenƒëingRequest` v√† `Ticket` model. 


# Truy c·∫≠p v√†o Builder t·ª´ Model 

M·ªôt trong nhi·ªÅu ƒëi·ªÅu th√∫ v·ªã m√† Eloquent ƒë√£ l√†m l√† cung c·∫•p c√°ch d·ªÖ d√†ng ƒë·ªÉ truy c·∫≠p v√†o ƒë·ªëi t∆∞·ª£ng `Builder` t·ª´ `model`. B·∫±ng c√°ch h∆∞·ªõng b·∫•t k·ª≥ cu·ªôc g·ªçi c√°c ph∆∞∆°ng th·ª©c c√°i m√† kh√¥ng t·ªìn t·∫°i tr√™n model t·ªõi 1 `new Builder`
```php

class Ticket{

 use ForwardsCalls;
 //url();
 
 public  function  newRequest():RequestBuilder 
 {
 
 return new RequetBuilder($this);
 }
 
 public function __call($method, $parameters)
 {
 return $this->forwardCallTo($this->newRequest(), $method, $parameters);
 }
}
```

```php

$tickets = Ticket::get();

// instead of

$tickets = (new RequestBuilder(new Ticket))->get();
```

# CH·ªânh s·ª≠a request 
Cho m·ªói ph∆∞∆°ng th·ª©c x√¢y d·ª±ng kh√°c nh∆∞ `where`, `whereIn`, `whereNot`, `limit`,`select`.... M·ªói cu·ªôc g·ªçi `RequestBuider` s·∫Ω th·ª±c hi·ªán ƒëi·ªÅu ch·ªânh c√°c `PendingRquest` ƒë∆°n gi·∫£n. M·ªói ƒëi·ªÅu ch·ªânh, m·ªôt li√™n k·∫øt kh√°c trong chu·ªói, 
c√°i m√† s·∫Ω ƒë∆∞·ª£c g·ª≠i, cu√¥i c√πng v·ªõi `get()`.


```php

public function where(string $field, $operator = null, mixed $value = null): static
{
    if (func_num_args() === 2) {
        $value = $operator;
        $operator = '=';
    }
    
    $options = $this->request->getOptions();

    $conditions = data_get($options, 'query.conditions');
    
    $conditions = ! empty($conditions) ? explode(' and ', $conditions) : [];
    
    $value = match (true) {
        $value instanceof Carbon => "[{$value->toIso8601String()}]",
        is_string($value) => "'{$value}'",
        is_array($value) => "'{$value[0]}'",
        is_bool($value) => $value ? 'true' : 'false',
        is_null($value) => 'null',
        default => $value,
    };
    
    $conditions[] = "{$field}{$operator}{$value}";
    
    $conditions = implode(' and ', $conditions);
    
    data_set($options, 'query.conditions', $conditions);
    
    $this->request->withOptions($options);

    return $this;
```

ƒê·ªçc t√†i li·ªáu cho c·∫£ API c√°i m√† b·∫°n ƒëang th·ª±c hi·ªán c√°c request t·ªõi v√† HTTP Client c·ªßa Laravel. Nh·∫≠n c√°c th√¥ng tin th·ª±c v·ªõi ch√∫ng. H·∫´y ƒë√†o s√¢u v√†o t√†i li·ªáu.T√¥i ch∆∞a bao gi·ªù h·ªëi ti·∫øc v·ªÅ n√≥ v·ªÅ n√≥. 

# Chu·∫©n b·ªã nhi·ªÅu h∆°n cho models 


CH√∫ng ta c√≥ th·ªÉ chuy·ªÉn h·∫ßu h·∫øt c√°c ph∆∞∆°ng th·ª©c c·ªßa model `T·ªãcket` sang class `Model` ƒë·ªÉ c√°c model kh√°c c√≥ th·ªÉ m·ªü r·ªông. 
```php

abstract class Model
{
    use ForwardsCalls;

    abstract public function url(): string;
    
    // get()
    // newRequest()
    // __call()
    // __callStatic()
}
```
```php

class Ticket extends Model
{
    public function url(): string
    {
        return '/tickets';
    }
}
```

# HTTP Marco 

ƒê·ªÉ t·∫°o n√™n c·∫•u tr√∫c c·ªßa `RequestBuilder` kh√¥ng d√†i d√≤ng, ch√∫ng ta c√≥ th·ªÉ s·ª≠ d·ª•ng 1 HTTP marco 

```php

public function boot()
{
HTTP::marco('connectWise', function(){
   $settings = config('services.connectwise');
        
        return Http::baseUrl($settings['url'])
            ->withBasicAuth(
                "{$settings['company_id']}+{$settings['public_key']}",
                $settings['private_key'],
            )
            ->asJson()
            ->acceptJson()
            ->withHeaders(['clientId' => $settings['client_id']])
            ->throw();
})
}
```

# Ph·∫°m vi request 

T√¥i th·ª±c s·ª± th√≠ch `query scope` trong Eloquent. Nh∆∞ nh·ªØng th·ª©c nh·ªè kh√°c.N√≥ l√†m cho tr·∫£i nghi·ªám c·ªßa dev tr·ªü n√™n t·ªët h∆°n r·∫•t nhi·ªÅu. 


```php
class Ticket extends Model
{
    // url()
    
    public function open(): RequestBuilder
    {
        return $this->where('status', 'open');
    }
}
```

```php

Ticket::open()->get();

// instead of

Ticket::where('status', 'open')->get();
```
N·∫øu c√≥ 1 m√¥ h√¨nh m·ªõi c·∫ßn scope `open()` ch√∫ng ta n√™n g√≥i n√≥ trong 1 `trait` HasStatus.

# Nh·ªØng √Ω ki·∫øn kh√°c 

ƒê·ªÉ cho ng·∫Øn g·ªçn, t√¥i s·∫Ω b·ªè qua nh·ªØng ch·ªß ƒë·ªÅ ch√≠nh nh∆∞ ƒë·ªãnh nghƒ©a c√°c m·ªëi quan h·ªá. T√¥i s·∫Ω gi·∫£i quy·∫øt ch√∫ng t∆∞∆°ng t·ª±. Eloquent ƒë√£ x·ª≠ l√Ω n√≥ nh∆∞ n√†o? M·∫∑c d√π n·∫øu c√¢u tr·∫£ l·ªùi l√† 'n√≥ kh√¥ng l√†m g√¨', n√≥ v·∫´n l√† n∆°i t·ªët ƒë·ªÉ b·∫Øt ƒë·∫ßu 
# B·∫°n nghƒ© g√¨? 
 T√¥i th·ª±c s·ª± th√≠ch c√°c c·∫•u tr√∫c c·ªßa SDKs n√†y v√† ƒë√£ s·ª≠ d·ª•ng phuong ph√°p n√†y th√†nh c√¥ng trong nhi·ªÅu nƒÉm. Nh∆∞ng t√¥i mu·ªën bi·∫øt suy nghƒ© c·ªßa b·∫°n. H√£y cho t√¥i bi·∫øt 


ƒê√¢y l√† ph·∫ßn hai c·ªßa ch·ªß ƒë·ªÅ n√†y ..B·∫•m [v√†o ƒë√¢y ](https://github.com/vn0202/web-knowledge/blob/main/SDKs-%20The-Laravel-way.md)


